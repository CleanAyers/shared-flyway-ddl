name: Check Sync Status

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

# Add proper permissions for issue management and status checks
permissions:
  contents: read           # Allow reading repository contents
  issues: write           # Allow creating/closing sync drift issues
  actions: read           # Allow reading workflow status
  metadata: read          # Allow reading repository metadata

jobs:
  check-status:
    name: Monitor Repository Sync Status
    runs-on: ubuntu-latest
    
    steps:
    - name: üîë Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üîç Check Sync Status
      id: status
      run: |
        echo "üîç Checking repository sync status..."
        if ./repo-tools/unified_flyway_sync.sh status; then
          echo "sync_ok=true" >> $GITHUB_OUTPUT
        else
          echo "sync_ok=false" >> $GITHUB_OUTPUT
        fi

    - name: üö® Create Drift Alert Issue
      if: steps.status.outputs.sync_ok != 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'üö® Repository Sync Drift Detected';
          const body = `
          ## ‚ö†Ô∏è Sync Drift Alert
          
          **Detection Time**: ${new Date().toISOString()}
          **Status**: Repositories are out of sync
          
          ### üîß Recommended Actions
          1. Run manual sync: \`./repo-tools/unified_flyway_sync.sh sync --auto-commit\`
          2. If that fails, consider nuclear reset: \`./repo-tools/unified_flyway_sync.sh nuclear\`
          3. Check the latest workflow logs for details
          
          ### üìä Status Details
          Run \`./repo-tools/unified_flyway_sync.sh status\` for detailed information.
          
          ---
          *This issue was automatically created by the sync monitoring workflow.*
          `;
          
          // Check if drift issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'sync-drift'
          });
          
          if (issues.data.length === 0) {
            // Create new drift issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['sync-drift', 'automated']
            });
          }

    - name: ‚úÖ Close Drift Issues
      if: steps.status.outputs.sync_ok == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // Close any open drift issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'sync-drift'
          });
          
          for (const issue of issues.data) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: '‚úÖ Sync status restored. All repositories are now synchronized.'
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
          }