name: Check Sync Status

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check-status:
    name: Monitor Repository Sync Status
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”‘ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ› ï¸ Setup Git Configuration
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: ðŸ“Š Generate Status Report
      id: status
      run: |
        echo "# ðŸ“Š Repository Sync Status Report" > status_report.md
        echo "Generated: $(date)" >> status_report.md
        echo "" >> status_report.md
        
        # Run status check and capture output
        if ./repo-tools/unified_flyway_sync.sh status > status_output.txt 2>&1; then
          echo "âœ… All repositories are in sync" >> status_report.md
          echo "sync_status=success" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Some repositories are out of sync" >> status_report.md
          echo "sync_status=out_of_sync" >> $GITHUB_OUTPUT
        fi
        
        echo "" >> status_report.md
        echo "## Detailed Status" >> status_report.md
        echo '```' >> status_report.md
        cat status_output.txt >> status_report.md
        echo '```' >> status_report.md
        
        # Display status for GitHub Actions logs
        echo "ðŸ“Š Current Sync Status:"
        cat status_output.txt

    - name: ðŸ“Ž Upload Status Report
      uses: actions/upload-artifact@v4
      with:
        name: sync-status-report-${{ github.run_number }}
        path: status_report.md
        retention-days: 7

    - name: ðŸ”” Create Issue on Sync Drift
      if: steps.status.outputs.sync_status == 'out_of_sync'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: existingIssues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['sync-drift'],
            state: 'open'
          });

          if (existingIssues.length === 0) {
            const issueBody = `
          ## ðŸš¨ Repository Sync Drift Detected

          **Automated monitoring has detected that some child repositories are out of sync.**

          ### Quick Fix
          Run the following command to restore sync:
          \`\`\`bash
          ./repo-tools/unified_flyway_sync.sh full --auto-commit
          \`\`\`

          ### Manual Trigger
          You can also trigger auto-sync manually: [Run Auto Sync Workflow](../actions/workflows/auto-sync.yml)

          ### Status Details
          See the latest [sync status report](../actions/workflows/sync-status.yml) for detailed information.

          ---
          *This issue was automatically created by the sync monitoring system.*
          *It will be automatically closed when all repositories are back in sync.*
          `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Repository Sync Drift Detected',
              body: issueBody,
              labels: ['sync-drift', 'automated']
            });
          }

    - name: ðŸŽ¯ Close Resolved Sync Issues
      if: steps.status.outputs.sync_status == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: existingIssues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['sync-drift'],
            state: 'open'
          });

          for (const issue of existingIssues) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: 'âœ… **Sync drift resolved!** All repositories are now in sync. This issue has been automatically closed.'
            });
          }