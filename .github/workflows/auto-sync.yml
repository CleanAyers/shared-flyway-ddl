name: Auto Sync Child Repositories

on:
  push:
    branches: [ develop ]  # Changed from main to develop
    # Only run on shared file changes in develop
    paths:
      - 'read-write-flyway-files/**'
  pull_request:
    branches: [ main ]
    # Also run on PRs to main for validation
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch for sync (develop/main)'
        required: false
        default: 'develop'
        type: choice
        options:
        - develop
        - main
      force_nuclear:
        description: 'Use nuclear reset if normal sync fails'
        required: false
        default: false
        type: boolean

# Add proper permissions for GitHub Actions
permissions:
  contents: write          # Allow pushing to branches
  pull-requests: write     # Allow creating/updating PRs
  issues: write           # Allow creating issues for failed syncs
  actions: read           # Allow reading workflow status

env:
  CHILD_REPOS: 'flyway-1-pipeline flyway-1-grants flyway-2-pipeline flyway-2-grants'
  GH_TOKEN: ${{ secrets.PAT_TOKEN }}

jobs:
  auto-sync:
    name: Sync All Child Repositories
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”‘ Checkout Parent Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: ğŸ› ï¸ Setup Git Configuration
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: ğŸ“¦ Install GitHub CLI
      run: |
        type -p curl >/dev/null || sudo apt update && sudo apt install curl -y
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y

    - name: ğŸ” Setup GitHub CLI Authentication
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        echo "ğŸ” Checking token type..."
        if [[ "$GH_TOKEN" == github_pat_* ]]; then
          echo "âœ… Using Personal Access Token (PAT)"
        elif [[ "$GH_TOKEN" == ghs_* ]]; then
          echo "âš ï¸  Using GitHub Actions token (limited access)"
        else
          echo "â“ Unknown token type: ${GH_TOKEN:0:10}..."
        fi
        # GitHub CLI will automatically use GH_TOKEN environment variable
        # No need for interactive login when GH_TOKEN is set
        gh auth status

    - name: ğŸ”§ Setup Git Credentials for Token Authentication
      run: |
        git config --global url."https://${GH_TOKEN}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

    - name: ğŸ“‚ Clone Child Repositories
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        echo "ğŸ“‚ Cloning child repositories..."
        cd /home/runner/work/shared-flyway-ddl
        
        # Verify authentication
        gh auth status || { echo "âŒ gh authentication failed"; exit 1; }
        
        for repo in flyway-1-pipeline flyway-1-grants flyway-2-pipeline flyway-2-grants; do
          echo "Checking CleanAyers/$repo..."
          if ! gh repo view "CleanAyers/$repo" >/dev/null 2>&1; then
            echo "âŒ CleanAyers/$repo does not exist or gh cannot access it. Visit: https://github.com/CleanAyers/$repo"
            echo "ğŸ”’ Note: If this is a private repository, you need to use a Personal Access Token (PAT)"
            echo "    The default GITHUB_TOKEN cannot access other private repositories"
            # stop early so we don't attempt partial syncs
            exit 1
          fi
        
          if [ ! -d "$repo" ]; then
            echo "Cloning $repo..."
            if gh repo clone "CleanAyers/$repo" "$repo"; then
              echo "âœ… Successfully cloned $repo with gh"
            elif git clone "https://${GH_TOKEN}:x-oauth-basic@github.com/CleanAyers/$repo.git" "$repo"; then
              echo "âœ… Successfully cloned $repo with git"
            else
              echo "âŒ Failed to clone CleanAyers/$repo via gh and git. Check token and repo permissions."
              exit 1
            fi
          else
            echo "$repo already exists, updating..."
            cd "$repo"
            git fetch --all
            git reset --hard origin/main || true
            cd ..
          fi
        done
        
        echo "âœ… All accessible child repositories ready"

    - name: ğŸ” Check Current Sync Status
      id: initial_status
      run: |
        echo "ğŸ” Checking current sync status..."
        ./repo-tools/unified_flyway_sync.sh status || echo "status_check_failed=true" >> $GITHUB_OUTPUT

    - name: ğŸ“¤ Publish Shared Content to Delivery Branch
      run: |
        echo "ğŸ“¤ Publishing shared content to delivery branch..."
        ./repo-tools/unified_flyway_sync.sh publish

    - name: ğŸ”„ Sync Child Repositories
      id: sync
      run: |
        echo "ğŸ”„ Syncing child repositories..."
        if ./repo-tools/unified_flyway_sync.sh sync --auto-commit; then
          echo "sync_success=true" >> $GITHUB_OUTPUT
        else
          echo "sync_success=false" >> $GITHUB_OUTPUT
          if [[ "${{ github.event.inputs.force_nuclear }}" == "true" ]]; then
            echo "ğŸš¨ Normal sync failed, attempting nuclear reset..."
            ./repo-tools/unified_flyway_sync.sh nuclear --auto-commit
          fi
        fi

    - name: ğŸ“Š Verify Final Sync Status
      run: |
        echo "ğŸ“Š Verifying final sync status..."
        ./repo-tools/unified_flyway_sync.sh status

    - name: ğŸ“ Generate Sync Report
      run: |
        echo "# ğŸ”„ Sync Report - $(date)" > sync_report.md
        echo "" >> sync_report.md
        echo "## Status Summary" >> sync_report.md
        echo "- **Trigger**: Push to main branch" >> sync_report.md
        echo "- **Commit**: ${{ github.sha }}" >> sync_report.md
        echo "- **Author**: ${{ github.actor }}" >> sync_report.md
        echo "" >> sync_report.md
        
        if [[ "${{ steps.sync.outputs.sync_success }}" == "true" ]]; then
          echo "âœ… **Result**: All repositories successfully synchronized" >> sync_report.md
        else
          echo "âŒ **Result**: Synchronization failed" >> sync_report.md
        fi
        
        echo "" >> sync_report.md
        echo "## Detailed Status" >> sync_report.md
        echo '```' >> sync_report.md
        ./repo-tools/unified_flyway_sync.sh status >> sync_report.md 2>&1 || true
        echo '```' >> sync_report.md

    - name: ğŸ“ Upload Sync Report
      uses: actions/upload-artifact@v4
      with:
        name: sync-report-${{ github.run_number }}
        path: sync_report.md
        retention-days: 30

    - name: ğŸš¨ Handle Sync Failure
      if: steps.sync.outputs.sync_success != 'true'
      run: |
        echo "ğŸš¨ SYNC FAILURE DETECTED"
        echo "âŒ Automatic synchronization failed for commit ${{ github.sha }}"
        echo "ğŸ‘† Check the logs above for details"
        echo "ğŸ”§ Consider running manual sync or nuclear reset"
        echo ""
        echo "Quick fix commands:"
        echo "  ./repo-tools/unified_flyway_sync.sh sync --auto-commit"
        echo "  ./repo-tools/unified_flyway_sync.sh nuclear  # (if needed)"
        exit 1