name: Auto Sync Child Repositories

on:
  push:
    branches: [ main ]
    paths:
      - 'read-write-flyway-files/**'
  workflow_dispatch:
    inputs:
      force_nuclear:
        description: 'Use nuclear reset if normal sync fails'
        required: false
        default: false
        type: boolean

# Add proper permissions for GitHub Actions
permissions:
  contents: write          # Allow pushing to branches
  pull-requests: write     # Allow creating/updating PRs
  issues: write           # Allow creating issues for failed syncs
  actions: read           # Allow reading workflow status
  metadata: read          # Allow reading repository metadata

env:
  CHILD_REPOS: 'flyway-1-pipeline flyway-1-grants flyway-2-pipeline flyway-2-grants'

jobs:
  auto-sync:
    name: Sync All Child Repositories
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”‘ Checkout Parent Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ› ï¸ Setup Git Configuration
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: ğŸ“Š Check Sync Status
      id: status
      run: |
        echo "ğŸ” Checking current sync status..."
        ./repo-tools/unified_flyway_sync.sh status || echo "status_check_failed=true" >> $GITHUB_OUTPUT
        
    - name: ğŸ“¤ Publish Parent Content
      run: |
        echo "ğŸ“¤ Publishing shared content to delivery branch..."
        ./repo-tools/unified_flyway_sync.sh publish

    - name: ğŸ”„ Sync All Children
      id: sync
      run: |
        echo "ğŸ”„ Starting automatic sync of all child repositories..."
        if ./repo-tools/unified_flyway_sync.sh sync --auto-commit; then
          echo "sync_success=true" >> $GITHUB_OUTPUT
          echo "âœ… Normal sync completed successfully"
        else
          echo "sync_success=false" >> $GITHUB_OUTPUT
          echo "âŒ Normal sync failed"
          exit 1
        fi

    - name: â˜¢ï¸ Nuclear Reset (if normal sync failed)
      if: failure() && github.event.inputs.force_nuclear == 'true'
      run: |
        echo "â˜¢ï¸ Normal sync failed, attempting nuclear reset..."
        echo "âš ï¸ This will overwrite any local changes in child repositories"
        ./repo-tools/unified_flyway_sync.sh nuclear --force-nuclear

    - name: ğŸ“Š Final Status Verification
      if: always()
      run: |
        echo "ğŸ“Š Verifying final sync status..."
        ./repo-tools/unified_flyway_sync.sh status

    - name: ğŸ“ Create Sync Report
      if: always()
      run: |
        echo "# ğŸ”„ Sync Report - $(date)" > sync_report.md
        echo "" >> sync_report.md
        echo "## Status Summary" >> sync_report.md
        echo "- **Trigger**: Push to main branch" >> sync_report.md
        echo "- **Commit**: ${{ github.sha }}" >> sync_report.md
        echo "- **Author**: ${{ github.actor }}" >> sync_report.md
        echo "" >> sync_report.md
        
        if [[ "${{ steps.sync.outputs.sync_success }}" == "true" ]]; then
          echo "âœ… **Result**: All repositories successfully synchronized" >> sync_report.md
        else
          echo "âŒ **Result**: Synchronization failed" >> sync_report.md
        fi
        
        echo "" >> sync_report.md
        echo "## Detailed Status" >> sync_report.md
        echo '```' >> sync_report.md
        ./repo-tools/unified_flyway_sync.sh status >> sync_report.md 2>&1 || true
        echo '```' >> sync_report.md

    - name: ğŸ“ Upload Sync Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sync-report-${{ github.run_number }}
        path: sync_report.md
        retention-days: 30

    - name: ğŸš¨ Notify on Failure
      if: failure()
      run: |
        echo "ğŸš¨ SYNC FAILURE DETECTED"
        echo "âŒ Automatic synchronization failed for commit ${{ github.sha }}"
        echo "ğŸ‘† Check the logs above for details"
        echo "ğŸ”§ Consider running manual sync or nuclear reset"
        echo ""
        echo "Quick fix commands:"
        echo "  ./repo-tools/unified_flyway_sync.sh sync --auto-commit"
        echo "  ./repo-tools/unified_flyway_sync.sh nuclear  # (if needed)"