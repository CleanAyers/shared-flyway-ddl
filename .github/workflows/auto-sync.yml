name: Auto Sync Child Repositories

on:
  push:
    branches: [ main ]
    paths:
      - 'read-write-flyway-files/**'
  workflow_dispatch:
    inputs:
      force_nuclear:
        description: 'Use nuclear reset if normal sync fails'
        required: false
        default: false
        type: boolean

# Add proper permissions for GitHub Actions
permissions:
  contents: write          # Allow pushing to branches
  pull-requests: write     # Allow creating/updating PRs
  issues: write           # Allow creating issues for failed syncs
  actions: read           # Allow reading workflow status

env:
  CHILD_REPOS: 'flyway-1-pipeline flyway-1-grants flyway-2-pipeline flyway-2-grants'

jobs:
  auto-sync:
    name: Sync All Child Repositories
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”‘ Checkout Parent Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ› ï¸ Setup Git Configuration
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: ğŸ“¦ Install GitHub CLI
      run: |
        type -p curl >/dev/null || sudo apt update && sudo apt install curl -y
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y

    - name: ğŸ” Setup GitHub CLI Authentication
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

    - name: ğŸ” Check Current Sync Status
      id: initial_status
      run: |
        echo "ğŸ” Checking current sync status..."
        ./repo-tools/unified_flyway_sync.sh status || echo "status_check_failed=true" >> $GITHUB_OUTPUT

    - name: ğŸ“¤ Publish Shared Content to Delivery Branch
      run: |
        echo "ğŸ“¤ Publishing shared content to delivery branch..."
        ./repo-tools/unified_flyway_sync.sh publish

    - name: ğŸ”„ Sync Child Repositories
      id: sync
      run: |
        echo "ğŸ”„ Syncing child repositories..."
        if ./repo-tools/unified_flyway_sync.sh sync --auto-commit; then
          echo "sync_success=true" >> $GITHUB_OUTPUT
        else
          echo "sync_success=false" >> $GITHUB_OUTPUT
          if [[ "${{ github.event.inputs.force_nuclear }}" == "true" ]]; then
            echo "ğŸš¨ Normal sync failed, attempting nuclear reset..."
            ./repo-tools/unified_flyway_sync.sh nuclear --auto-commit
          fi
        fi

    - name: ğŸ“Š Verify Final Sync Status
      run: |
        echo "ğŸ“Š Verifying final sync status..."
        ./repo-tools/unified_flyway_sync.sh status

    - name: ğŸ“ Generate Sync Report
      run: |
        echo "# ğŸ”„ Sync Report - $(date)" > sync_report.md
        echo "" >> sync_report.md
        echo "## Status Summary" >> sync_report.md
        echo "- **Trigger**: Push to main branch" >> sync_report.md
        echo "- **Commit**: ${{ github.sha }}" >> sync_report.md
        echo "- **Author**: ${{ github.actor }}" >> sync_report.md
        echo "" >> sync_report.md
        
        if [[ "${{ steps.sync.outputs.sync_success }}" == "true" ]]; then
          echo "âœ… **Result**: All repositories successfully synchronized" >> sync_report.md
        else
          echo "âŒ **Result**: Synchronization failed" >> sync_report.md
        fi
        
        echo "" >> sync_report.md
        echo "## Detailed Status" >> sync_report.md
        echo '```' >> sync_report.md
        ./repo-tools/unified_flyway_sync.sh status >> sync_report.md 2>&1 || true
        echo '```' >> sync_report.md

    - name: ğŸ“ Upload Sync Report
      uses: actions/upload-artifact@v4
      with:
        name: sync-report-${{ github.run_number }}
        path: sync_report.md
        retention-days: 30

    - name: ğŸš¨ Handle Sync Failure
      if: steps.sync.outputs.sync_success != 'true'
      run: |
        echo "ğŸš¨ SYNC FAILURE DETECTED"
        echo "âŒ Automatic synchronization failed for commit ${{ github.sha }}"
        echo "ğŸ‘† Check the logs above for details"
        echo "ğŸ”§ Consider running manual sync or nuclear reset"
        echo ""
        echo "Quick fix commands:"
        echo "  ./repo-tools/unified_flyway_sync.sh sync --auto-commit"
        echo "  ./repo-tools/unified_flyway_sync.sh nuclear  # (if needed)"
        exit 1