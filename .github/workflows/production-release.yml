name: Production Release to Main

on:
  pull_request:
    types: [closed]
    branches: [ main ]
    paths:
      - 'read-write-flyway-files/**'
  push:
    branches: [ dev ]
    paths:
      - 'read-write-flyway-files/**'
  workflow_dispatch:
    inputs:
      emergency_release:
        description: 'Emergency release (skips some checks)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

env:
  CHILD_REPOS: 'flyway-1-pipeline flyway-1-grants flyway-2-pipeline flyway-2-grants'
  # Use flyway-sync-token with broader permissions instead of GITHUB_TOKEN
  GH_TOKEN: ${{ secrets.FLYWAY_SYNC_TOKEN }}

jobs:
  production-sync:
    name: Production Sync to All Child Repositories
    runs-on: ubuntu-latest
    # Run if: PR merged to main, OR pushed to dev, OR manual trigger
    if: github.event.pull_request.merged == true || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ðŸ”‘ Checkout Parent Repository
      uses: actions/checkout@v4
      with:
        # Use PAT token instead of GITHUB_TOKEN for broader access
        token: ${{ secrets.FLYWAY_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ðŸ› ï¸ Setup Git Configuration
      env:
        # Use PAT token if available, fallback to GITHUB_TOKEN
        ACCESS_TOKEN: ${{ secrets.FLYWAY_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        # Configure Git to use token for all GitHub operations
        git config --global url."https://x-access-token:${ACCESS_TOKEN}@github.com/".insteadOf "https://github.com/"
        # Disable interactive prompts for credentials
        git config --global credential.helper ""
        git config --global core.askPass ""
        # Set environment variables to prevent interactive prompts
        echo "GIT_ASKPASS=true" >> $GITHUB_ENV
        echo "GIT_TERMINAL_PROMPT=0" >> $GITHUB_ENV

    - name: ðŸ” Setup GitHub CLI Authentication
      env:
        GH_TOKEN: ${{ secrets.FLYWAY_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ” Setting up GitHub CLI authentication"
        if [[ -n "${{ secrets.FLYWAY_SYNC_TOKEN }}" ]]; then
          echo "Using FLYWAY_SYNC_TOKEN for enhanced permissions"
        else
          echo "Using GITHUB_TOKEN with standard permissions"
        fi
        gh auth status

    - name: ðŸ“‚ Clone Child Repositories
      env:
        GH_TOKEN: ${{ secrets.FLYWAY_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        ACCESS_TOKEN: ${{ secrets.FLYWAY_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ“‚ Cloning child repositories for sync..."
        cd /home/runner/work/shared-flyway-ddl
        
        for repo in flyway-1-pipeline flyway-1-grants flyway-2-pipeline flyway-2-grants; do
          echo "Checking CleanAyers/$repo..."
          if ! gh repo view "CleanAyers/$repo" >/dev/null 2>&1; then
            echo "âŒ CleanAyers/$repo does not exist or cannot be accessed."
            echo "This might be due to insufficient token permissions."
            exit 1
          fi
        
          if [ ! -d "$repo" ]; then
            echo "Cloning $repo with authentication..."
            if gh repo clone "CleanAyers/$repo" "$repo"; then
              echo "âœ… Successfully cloned $repo"
              # Configure credentials for this specific repo using PAT token
              cd "$repo"
              git config remote.origin.url "https://x-access-token:${ACCESS_TOKEN}@github.com/CleanAyers/$repo.git"
              cd ..
            else
              echo "âŒ Failed to clone CleanAyers/$repo"
              exit 1
            fi
          else
            echo "$repo already exists, updating..."
            cd "$repo"
            # Configure credentials for existing repo using PAT token
            git config remote.origin.url "https://x-access-token:${ACCESS_TOKEN}@github.com/CleanAyers/$repo.git"
            git fetch --all
            git reset --hard origin/main || true
            cd ..
          fi
        done

    - name: ðŸš€ Publish and Sync
      id: sync_step
      env:
        GH_TOKEN: ${{ secrets.FLYWAY_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        ACCESS_TOKEN: ${{ secrets.FLYWAY_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        GIT_ASKPASS: "true"
        GIT_TERMINAL_PROMPT: "0"
      run: |
        echo "ðŸš€ Starting sync process..."
        
        # Publish to delivery branch
        echo "ðŸ“¤ Publishing shared content to delivery branch..."
        ./repo-tools/unified_flyway_sync.sh publish
        
        # Sync all child repositories
        echo "ðŸ”„ Syncing child repositories..."
        if ./repo-tools/unified_flyway_sync.sh sync --auto-commit; then
          echo "sync_success=true" >> $GITHUB_OUTPUT
        else
          echo "sync_success=false" >> $GITHUB_OUTPUT
          echo "âŒ Sync failed!"
          exit 1
        fi

    - name: ðŸ“Š Verify Sync Status
      run: |
        echo "ðŸ“Š Verifying sync status..."
        ./repo-tools/unified_flyway_sync.sh status

    - name: ðŸ“ Generate Sync Report
      run: |
        echo "# ðŸš€ Sync Report - $(date)" > sync_report.md
        echo "" >> sync_report.md
        echo "## Sync Summary" >> sync_report.md
        echo "- **Commit**: ${{ github.sha }}" >> sync_report.md
        echo "- **Triggered by**: ${{ github.actor }}" >> sync_report.md
        echo "- **Sync time**: $(date)" >> sync_report.md
        
        if [[ "${{ steps.sync_step.outputs.sync_success }}" == "true" ]]; then
          echo "âœ… **Status**: Sync successful" >> sync_report.md
        else
          echo "âŒ **Status**: Sync failed" >> sync_report.md
        fi
        
        echo "" >> sync_report.md
        echo "## Synchronized Repositories" >> sync_report.md
        echo "- flyway-1-pipeline" >> sync_report.md
        echo "- flyway-1-grants" >> sync_report.md
        echo "- flyway-2-pipeline" >> sync_report.md
        echo "- flyway-2-grants" >> sync_report.md
        echo "" >> sync_report.md
        echo "## Detailed Status" >> sync_report.md
        echo '```' >> sync_report.md
        ./repo-tools/unified_flyway_sync.sh status >> sync_report.md 2>&1 || true
        echo '```' >> sync_report.md

    - name: ðŸ“Ž Upload Sync Report
      uses: actions/upload-artifact@v4
      with:
        name: sync-report-${{ github.run_number }}
        path: sync_report.md
        retention-days: 30